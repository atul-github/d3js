<!--
Author : Atul Pandit
Email : atul_pandit@yahoo.com / atul.pandit@gmail.com
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Bouncing Balls in rectangle using D3js - by Atul</title>
    <script src="d3.v3.min.js"></script>
</head>
<body>

<script>

    // Ball object - multiple balls can be created by instantiating new objects
    function Ball(svg, x, y, id, color, aoa, weight) {
        this.posX = x; // cx
        this.posY = y; // cy
        this.color = color;
        this.radius = weight; // radius and weight same
        this.jumpSize = 5; // equivalent of speed
        this.svg = svg; // parent SVG
        this.id = id; // id of ball
        this.aoa = aoa; // initial angle of attack
        this.weight = weight;

        if (!this.aoa)
            this.aoa = Math.PI / 7;
        if (!this.weight)
            this.weight = 10;
        this.radius = this.weight;

        this.data = [this.id];

        var thisobj = this;

        // **** aoa is used only here -- earlier I was using to next move position.
        // Now aoa and speed together is velocity 
        this.vx = Math.cos(thisobj.aoa) * thisobj.jumpSize; // velocity x
        this.vy = Math.sin(thisobj.aoa) * thisobj.jumpSize; // velocity y

        this.Draw = function () {
            var svg = thisobj.svg;
            var ball = svg.selectAll('#' + thisobj.id)
                        .data(thisobj.data)
                    ;
            ball.enter()
                .append("circle")
                .attr("id", thisobj.id)
                .attr('class', 'ball')
                .attr("r", thisobj.radius)
                .attr("weight", thisobj.weight)
                .style("fill", function () {
                    if (typeof (thisobj.color) == 'undefined')
                        return "red";
                    else
                        return thisobj.color;
                })
                ;
            ball
                //.transition()
                //.duration(50)
                .attr("cx", thisobj.posX)
                .attr("cy", thisobj.posY)
                ;

        }

        this.Move = function () {
            var svg = thisobj.svg;

            //thisobj.posX += Math.cos(thisobj.aoa) * thisobj.jumpSize;
            //thisobj.posY += Math.sin(thisobj.aoa) * thisobj.jumpSize;

            thisobj.posX += thisobj.vx;
            thisobj.posY += thisobj.vy;

            if (parseInt(svg.attr('width')) <= (thisobj.posX + thisobj.radius)) {
                thisobj.posX = parseInt(svg.attr('width')) - thisobj.radius - 1;
                thisobj.aoa = Math.PI - thisobj.aoa;
                thisobj.vx = -thisobj.vx;
            }

            if ( thisobj.posX < thisobj.radius) {
                thisobj.posX = thisobj.radius+1;
                thisobj.aoa = Math.PI - thisobj.aoa;
                thisobj.vx = -thisobj.vx;
            }

            if (parseInt(svg.attr('height')) < (thisobj.posY + thisobj.radius)) {
                thisobj.posY = parseInt(svg.attr('height')) - thisobj.radius - 1;
                thisobj.aoa = 2 * Math.PI - thisobj.aoa;
                thisobj.vy = -thisobj.vy;
                console.log('new angle = ' + thisobj.aoa);
            }

            if (thisobj.posY < thisobj.radius) {
                thisobj.posY = thisobj.radius+1;
                thisobj.aoa = 2 * Math.PI - thisobj.aoa;
                thisobj.vy = -thisobj.vy;
            }

            // **** NOT USING AOA except during initilization *****

            if (thisobj.aoa > 2 * Math.PI)
                thisobj.aoa = thisobj.aoa - 2 * Math.PI;
            if (thisobj.aoa < 0)
                thisobj.aoa = 2 * Math.PI + thisobj.aoa;

            thisobj.Draw();
        }
    }

    //checking collision of balls in loop
    //there is some issue and one ball pull other ball - needs to work on that
    //courtsey http://gamedevelopment.tutsplus.com/tutorials/when-worlds-collide-simulating-circle-circle-collisions--gamedev-769
    function CheckCollision() {

        for (var i = 0; i < balls.length; ++i) {
            var ball1 = balls[i];
            for (var j = i + 1; j < balls.length; ++j) {
                ball2 = balls[j];

                var absx = Math.abs(parseFloat(ball2.posX) - parseFloat(ball1.posX));
                var absy = Math.abs(parseFloat(ball2.posY) - parseFloat(ball1.posY));

                // find distance between two balls.
                var distance = (absx * absx) + (absy * absy);
                distance = Math.sqrt(distance);

                // check if distance is less than sum of two radius - if yes, collision
                if (distance < (parseFloat(ball1.radius) + parseFloat(ball2.radius)) ) {

                    // intersection point
                    var interx = ((ball1.posX * ball2.radius) + ball2.posX * ball1.radius)
                    / (ball1.radius + ball2.radius);
                    var intery = ((ball1.posY * ball2.radius) + ball2.posY  * ball1.radius)
                    / (ball1.radius + ball2.radius);

                    var intersectionBall = svg.selectAll('#' + 'intersectionEffect')
                                 .data(['intersectionEffect']);
                    ;
                    intersectionBall.enter()
                        .append("circle")
                        .attr({ "id": 'intersectionEffect', 'class': 'ball2', 'r': 5, 'fill': 'black' })
                    ;

                    intersectionBall
                        .attr({ 'cx': interx, 'cy': intery, 'r': 5 })
                        .transition()
                        .duration(500)
                        .attr('r', 0)
                    ;

                    // new velocity of both the balls.
                    var vx1 = (ball1.vx * (ball1.weight - ball2.weight)
                     + (2 * ball2.weight * ball2.vx )) / (ball1.weight + ball2.weight);
                    var vy1 = (ball1.vy * (ball1.weight - ball2.weight)
                        + (2 * ball2.weight * ball2.vy)) / (ball1.weight + ball2.weight);
                    var vx2 = (ball2.vx * (ball2.weight - ball1.weight)
                        + (2 * ball1.weight * ball1.vx)) / (ball1.weight + ball2.weight);
                    var vy2 = (ball2.vy * (ball2.weight - ball1.weight)
                        + (2 * ball1.weight * ball1.vy)) / (ball1.weight + ball2.weight);

                    ball1.vx = vx1;
                    ball1.vy = vy1;
                    ball2.vx = vx2;
                    ball2.vy = vy2;

                    ball1.posX += ball1.vx;
                    ball1.posY += ball1.vy;

                    ball2.posX += ball2.vx;
                    ball2.posY += ball2.vy;

                    ball1.Draw();
                    ball2.Draw();
                }
            }
        }
    }

    var balls = [];
    function Initialize(containerId) {
        var height = document.getElementById(containerId).clientHeight;
        var width = document.getElementById(containerId).clientWidth;
        gContainerId = containerId;
        gCanvasId = containerId + '_canvas';
        gTopGroupId = containerId + '_topGroup';
        var svg = d3.select("#" + containerId).append("svg")
            .attr("id", gCanvasId)
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("id", gTopGroupId)
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
        //.attr("transform", "translate(" + 1 + "," + 1 + ")")
        ;

        //keep pushing as many balls you want..
        balls.push(new Ball(svg, 501, 101, 'n1', 'red', Math.PI / 6));
        balls.push(new Ball(svg, 51, 31, 'n2', 'green', Math.PI / 3, 20));
        balls.push(new Ball(svg, 201, 201, 'n3', 'yellow', Math.PI / 9, 90));
        balls.push(new Ball(svg, 91, 31, 'n4', 'orange', Math.PI / 2, 15));
        balls.push(new Ball(svg, 201, 21, 'n5', 'pink', Math.PI + Math.PI / 4, 15));
        balls.push(new Ball(svg, 401, 41, 'n6', 'blue', Math.PI + Math.PI / 7, 25));

        for (var i = 0; i < balls.length; ++i) {
            balls[i].Draw();
        }
        return svg;
    }

    var intervalId = null;
    function StartStopGame() {
        if (intervalId == null) {
            d3.timer(function () {
                for (var i = 0; i < balls.length; ++i) {
                    var r = balls[i].Move();
                    CheckCollision();
                }
                if (intervalId == null)
                    return true;
                else
                    return false;
            }, 500);
            intervalId = 1;
            document.getElementById('startStop').innerHTML = 'Stop';
        }
        else {
            clearInterval(intervalId);
            intervalId = null;
            document.getElementById('startStop').innerHTML = 'Start';
        }
    }
    // I always like to handle ESC key
    d3.select('body')
            .on('keydown', function () {
                if (balls.length == 0)
                    return;
                console.log(d3.event);
                if (d3.event.keyCode == 27) { // if ESC key - toggle start stop
                    StartStopGame();
                }
            });
</script>
<h2>
    Simple Bouncing Balls in rectangle using D3js - by Atul
</h2>
<div id="mainDiv" style="width:850px; height:500px">
    <div id="drawAreaOuter" style="width:100%; height:100%; float:left; ">
        <div id="menuTop" >
            <a id="startStop" href="javascript:StartStopGame()" >Start</a>
        </div>
        <div id="drawArea" style="width:100%; height:100%; border:1px solid gray">
        </div>
    </div>
</div>

<script>
    var svg = Initialize('drawArea');
</script>

</body>
</html>

